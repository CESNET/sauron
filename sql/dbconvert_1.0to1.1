/* convert Sauron database format from 1.0 to 1.1 */


/* hosts */

ALTER TABLE hosts ADD COLUMN vmps INT4;
ALTER TABLE hosts ALTER COLUMN vmps SET DEFAULT -1;
UPDATE hosts SET vmps=-1;

ALTER TABLE hosts ADD COLUMN dhcp_last INT4;
ALTER TABLE hosts ALTER COLUMN dhcp_last SET DEFAULT -1;
UPDATE hosts SET dhcp_last=-1;

/* users */
INSERT INTO user_rights (type,ref,rtype,rref) SELECT 2,id,0,gid FROM users WHERE gid > 0;
ALTER TABLE users DROP COLUMN gid;

/* lastlog */
ALTER TABLE lastlog ADD COLUMN host2 TEXT;
UPDATE lastlog SET host2=host;
ALTER TABLE lastlog DROP COLUMN host;
ALTER TABLE lastlog RENAME COLUMN host2 TO host;

/* utmp */
ALTER TABLE utmp DROP COLUMN gid;

/* vlan */
ALTER TABLE vlans ADD COLUMN vlanno INT;

/* groups */
ALTER TABLE groups ADD COLUMN vmps INT4;
ALTER TABLE groups ALTER COLUMN vmps SET DEFAULT -1;
UPDATE groups SET vmps=-1;

/* zones */
ALTER TABLE zones ADD COLUMN rdate INT4;
ALTER TABLE zones ALTER COLUMN rdate SET DEFAULT 0;
UPDATE zones SET rdate=0;


\i vmps.sql

UPDATE settings SET value='1.1' where key='dbversion';

/* eof */

