#########################################################################
# $Id$ 
# 
# Makefile for sauron
#
Version = 0.5.0
PKGNAME = sauron

DBASE = sauron

SHELL = /bin/sh
PERL  = @PERL@
LN_S  = @LN_S@

DEFS = @DEFS@

#INSTALL_ROOT =

srcdir = @srcdir@
VPATH = @srcdir@

prefix = @prefix@
exec_prefix = @exec_prefix@

# Where to install the configuration file(s)
sysconfdir = @sysconfdir@
etcdir = $(sysconfdir)/sauron

# Where to install the executables.
bindir = $(exec_prefix)/sauron

# Where to put libraries
libdir = $(prefix)/lib

# Where to put the Info files
infodir = $(prefix)/info

# Where to put the manual pages.
mandir = $(prefix)/man


RUNSQL = $(srcdir)/runsql

SGMLTOOLS = sgmltools

CC        = @CC@ 
XCPPFLAGS = @CPPFLAGS@
CFLAGS    = @CFLAGS@ $(XCPPFLAGS) $(DEFS)
LDFLAGS   = @LDFLAGS@
LIBS      = @LIBS@
STRIP     = strip


INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
INSTALL_PROGRAM = @INSTALL_PROGRAM@

@SET_MAKE@

# there should be no reason to modify lines below this
#########################################################################

SQL_TABLES =	sql/common.sql \
		sql/servers.sql \
		sql/zones.sql \
		sql/hosts.sql \
		sql/groups.sql \
		sql/nets.sql \
		sql/cidr_entries.sql sql/dhcp_entries.sql sql/ether_info.sql \
		sql/mx_entries.sql sql/mx_templates.sql \
		sql/ns_entries.sql \
		sql/printer_classes.sql sql/printer_entries.sql \
		sql/a_entries.sql sql/txt_entries.sql sql/srv_entries.sql \
	        sql/users.sql sql/user_rights.sql sql/user_groups.sql \
		sql/wks_entries.sql sql/wks_templates.sql \
		sql/utmp.sql sql/hinfo_templates.sql \
		sql/arec_entries.sql sql/root_servers.sql \
		sql/history.sql sql/lastlog.sql sql/news.sql \
		sql/vlans.sql 


SQL_MISC =      sql/DEFAULTS.sql sql/misc.sql sql/copy_tables.sql \
		sql/drop_tables.sql sql/hinfo_hw.sql sql/hinfo_sw.sql


PROGS = sauron addgroup adduser deluser modhosts \
	import import-ethers import-jyu import-roots \
	last moduser runsql status update-dhcp-info \
	export-networks generatehosts addhosts check-pending

MODULES = Sauron/Util.pm Sauron/DB.pm Sauron/BackEnd.pm Sauron/CGIutil.pm \
	  Sauron/UtilZone.pm


CONTRIB_FILES = contrib/additional-ether-codes.txt \
		contrib/Ethernet.txt \
		contrib/named.root \
		contrib/htmldoc-sql

CGIFILES = cgi/sauron.cgi cgi/browser.cgi
LOGOFILES = icons/logo.png icons/logo_large.png
MISCFILES = COPYING COPYRIGHT

DIRNAME = $(shell basename `pwd`) 
DISTNAME  = $(PKGNAME)-$(Version)
BACKUPNAME = $(PKGNAME)-`date +%b%d`

BINARIES = 
OBJS = 

.c.o:	
	$(CC) $(CFLAGS) $(OPTIONS) -c -o $*.o $<


all:	$(PKGNAME) 

$(PKGNAME):  $(BINARIES)
	@echo "All done"

#parse-hosts-rows:  parse-hosts-rows.c
#	$(CC) $(CFLAGS) -o parse-hosts-rows parse-hosts-rows.c $(LDFLAGS) $(LIBS) 


#strip:
#	for i in $(PKGNAME) ; do [ -x $$i ] && $(STRIP) $$i ; done

clean:
	rm -f *~ *.o core a.out make.log \#*\# $(OBJS) $(BINARIES)

clean_all: clean
	rm -f Makefile config.h config.log config.cache config.status

drop_tables:
	$(RUNSQL) -v -n sql/drop_tables.sql
	@echo "Database cleaned..."

make_tables: 
	@echo "Creating tables..."
	$(RUNSQL) $(SQL_TABLES) sql/copy_tables.sql \
				sql/misc.sql sql/DEFAULTS.sql

init_tables:
	@echo "Inserting ether infos..."
	$(srcdir)/import-ethers $(srcdir)/contrib/Ethernet.txt
	$(srcdir)/import-ethers --force \
	             $(srcdir)/contrib/additional-ether-codes.txt
	@echo "Inserting default HINFO templates..."
	$(RUNSQL) contrib/hinfo_hw.sql
	$(RUNSQL) contrib/hinfo_sw.sql

docs:	
	@echo "Generating docs..."
	cd $(srcdir)
	$(srcdir)/contrib/htmldoc-sql --title "Sauron: SQL table descriptions" $(SQL_TABLES) > doc/tables.html
	$(srcdir)/contrib/htmldoc-sql --docbook --title "Sauron: SQL table descriptions" $(SQL_TABLES) > doc/tables.sgml
	cd doc
	(cd doc; $(SGMLTOOLS) -b ps manual.sgml)
	(cd doc; $(SGMLTOOLS) -b html manual.sgml)

grant_full:
	perl -e 'while (<>) { s/:user:/tjko/g; print; }' init/full-privileges.sql | psql sauron

dist:	clean
	(cd .. ; tar cvzf $(DISTNAME).tar.gz $(DIRNAME))

backup:	clean
	(cd .. ; tar cvzf $(BACKUPNAME).tar.gz $(DIRNAME))



install: all make_dirs
	$(INSTALL) -m 644 config.in $(INSTALL_ROOT)/$(etcdir)/config.in
	if [ ! -f $(INSTALL_ROOT)/$(etcdir)/config ]; then \
	    $(INSTALL) -m 644 config.in $(INSTALL_ROOT)/$(etcdir)/config; \
	fi
	$(INSTALL) -m 644 config-browser.in \
		$(INSTALL_ROOT)/$(etcdir)/config-browser.in
	if [ ! -f $(INSTALL_ROOT)/$(etcdir)/config-browser ]; then \
	    $(INSTALL) -m 644 config-browser.in \
		$(INSTALL_ROOT)/$(etcdir)/config-browser; \
	fi
	$(INSTALL) -m 755 $(PROGS) $(INSTALL_ROOT)/$(bindir)
	$(INSTALL) -m 644 $(MISCFILES) $(INSTALL_ROOT)/$(bindir)
	$(INSTALL) -m 755 $(CGIFILES) $(INSTALL_ROOT)/$(bindir)/cgi
	$(INSTALL) -m 644 $(LOGOFILES) $(INSTALL_ROOT)/$(bindir)/icons
	$(INSTALL) -m 644 $(MODULES) $(INSTALL_ROOT)/$(bindir)/Sauron
	$(INSTALL) -m 644 $(SQL_TABLES) $(SQL_MISC) \
				 $(INSTALL_ROOT)/$(bindir)/sql
	$(INSTALL) -m 644 $(CONTRIB_FILES) $(INSTALL_ROOT)/$(bindir)/contrib
	@[ -f $(INSTALL_ROOT)/$(bindir)/modgroup ] && \
		 rm -f $(INSTALL_ROOT)/$(bindir)/modgroup || :
	@ln -s moduser $(INSTALL_ROOT)/$(bindir)/modgroup
# fix paths in perl files
	@echo "Fixing paths in perl files..."
	@for f in $(PROGS) $(CGIFILES); do \
		echo $(INSTALL_ROOT)/$(bindir)/$$f; \
		$(PERL) -p -i -e 's@^#!/usr/bin/perl -I/usr/local/sauron@#!$(PERL) -I$(bindir)@;' $(INSTALL_ROOT)/$(bindir)/$$f; \
	done

make_dirs:
	$(INSTALL) -m 755 -d $(INSTALL_ROOT)/$(etcdir)
	$(INSTALL) -m 755 -d $(INSTALL_ROOT)/$(bindir)
	$(INSTALL) -m 755 -d $(INSTALL_ROOT)/$(bindir)/backups
	$(INSTALL) -m 755 -d $(INSTALL_ROOT)/$(bindir)/cgi
	$(INSTALL) -m 755 -d $(INSTALL_ROOT)/$(bindir)/Sauron
	$(INSTALL) -m 755 -d $(INSTALL_ROOT)/$(bindir)/sql
	$(INSTALL) -m 755 -d $(INSTALL_ROOT)/$(bindir)/logs
	$(INSTALL) -m 755 -d $(INSTALL_ROOT)/$(bindir)/contrib
	$(INSTALL) -m 755 -d $(INSTALL_ROOT)/$(bindir)/icons


printable.man:
	groff -Tps -mandoc ./$(PKGNAME).1 >$(PKGNAME).ps
	groff -Tascii -mandoc ./$(PKGNAME).1 | tee $(PKGNAME).prn | sed 's/.//g' >$(PKGNAME).txt

install.man:
	$(INSTALL) -m 644 $(PKGNAME).1 $(mandir)/man1/$(PKGNAME).1



# a tradition !
love:	
	@echo "Not War - Eh?"
# eof

